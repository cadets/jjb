- job-group:
    name: 'bsd-ci-{branch}'
    jobs:
       - 'CADETS/bsd-{branch}-build'
       - 'CADETS/bsd-{branch}-vm'
       - 'CADETS/bsd-{branch}-bbn-vm'
       - 'CADETS/bsd-{branch}-test-vm'
       - 'CADETS/bsd-{branch}-test'

- job-template:
    name: 'CADETS/bsd-{branch}-build'
    description: FreeBSD trunk from the CADETS project ('{branch}' branch)
    defaults: global
    properties:
      - github:
          url: https://github.com/cadets/freebsd/
      - wall-display:
          text: FreeBSD ({branch}) build
    scm:
      - git:
          url: https://github.com/cadets/freebsd
          branches:
            - '*/{branch}'
          basedir: freebsd
    triggers:
      - github
    builders:
      - checkout-scripts
      - shell: sh -ex cadets-ci/scripts/cadets-build.sh
    publishers:
      - scan-clang-warnings
      - archive:
          artifacts: 'release-artifacts/MANIFEST, release-artifacts/base.txz, release-artifacts/kernel.txz, release-artifacts/tests.txz'
      - trigger-parameterized-builds:
        - project:
            - 'bsd-{branch}-vm'
            - 'bsd-{branch}-bbn-vm'
          condition: SUCCESS
          git-revision: true
      - slack-notification

- job-template:
    name: 'CADETS/bsd-{branch}-bbn-vm'
    defaults: global
    properties:
      - wall-display:
          text: BBN VM ({branch})
    node: vm_host
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'bsd-{branch}-build'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'release-artifacts/MANIFEST, release-artifacts/base.txz, release-artifacts/kernel.txz, release-artifacts/tests.txz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-bbn-vm.sh
    publishers:
      - archive:
          artifacts: 'cadets-bbn-vm.qcow2.xz'
      - slack-notification

- job-template:
    name: 'CADETS/bsd-{branch}-vm'
    defaults: global
    properties:
      - wall-display:
          text: FreeBSD ({branch}) VM
    node: vm_host
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'bsd-{branch}-build'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'release-artifacts/MANIFEST, release-artifacts/base.txz, release-artifacts/kernel.txz, release-artifacts/tests.txz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-vm.sh
    publishers:
      - archive:
          artifacts: 'disk-vm.img.xz'
      - slack-notification

- job-template:
    name: 'CADETS/bsd-{branch}-test-vm'
    defaults: global
    properties:
      - wall-display:
          text: FreeBSD ({branch}) test VM
    node: vm_host
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'bsd-{branch}-build'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'release-artifacts/MANIFEST, release-artifacts/base.txz, release-artifacts/kernel.txz, release-artifacts/tests.txz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-test-vm.sh
    publishers:
      - archive:
          artifacts: 'disk-test.img.xz'
      - trigger:
          project: 'bsd-{branch}-test'
          threshold: SUCCESS
      - slack-notification

- job-template:
    name: 'CADETS/bsd-{branch}-test'
    defaults: global
    properties:
      - wall-display:
          text: FreeBSD ({branch}) test
    node: sudo
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'bsd-{branch}-test-vm'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'disk-test.img.xz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-test.sh
    publishers:
      - publish-junit-results
      - slack-notification

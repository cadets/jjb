- job-group:
    name: 'cadets-bsd-ci-{branch}'
    jobs:
       - 'cadets-bsd-{branch}-build'
       - 'cadets-bsd-{branch}-vm'
       - 'cadets-bsd-{branch}-test'

- job-template:
    name: 'cadets-bsd-{branch}-build'
    description: FreeBSD trunk from the CADETS project ('{branch}' branch)
    defaults: global
    properties:
      - github:
          url: https://github.com/cadets/freebsd/
    scm:
      - git:
          url: https://github.com/cadets/freebsd
          branches:
            - '*/{branch}'
          basedir: freebsd
    triggers:
      - github
    builders:
      - checkout-scripts
      - shell: sh -ex cadets-ci/scripts/cadets-build.sh
    publishers:
      - scan-clang-warnings
      - archive:
          artifacts: 'freebsd/release/MANIFEST, freebsd/release/base.txz, freebsd/release/kernel.txz, freebsd/release/tests.txz'
      - trigger-parameterized-builds:
        - project:
            - 'cadets-bsd-{branch}-vm'
          condition: SUCCESS
          git-revision: true
      - slack-notification

- job-template:
    name: 'cadets-bsd-{branch}-vm'
    defaults: global
    node: vm_host
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'cadets-bsd-{branch}-build'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'freebsd/release/MANIFEST, freebsd/release/base.txz, freebsd/release/kernel.txz, freebsd/release/tests.txz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-vm.sh
    publishers:
      - archive:
          artifacts: 'disk-test.img.xz'
      - trigger:
          project: 'cadets-bsd-{branch}-test'
          threshold: SUCCESS
      - slack-notification

- job-template:
    name: 'cadets-bsd-{branch}-test'
    defaults: global
    node: sudo
    builders:
      - checkout-scripts
      - copyartifact:
          project: 'cadets-bsd-{branch}-vm'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: 'disk-test.img.xz'
          flatten: true
      - shell: sh -ex cadets-ci/scripts/cadets-test.sh
    publishers:
      - publish-junit-results
      - slack-notification
